<%
Request.AddRespHeader( "Access-Control-Allow-Origin", "http://localhost:3000" ); 
Request.AddRespHeader( "Access-Control-Allow-Credentials", "true" ); 
Request.AddRespHeader( "Access-Control-Allow-Methods", "GET,PUT,POST,DELETE,PATCH,OPTIONS" );
Request.AddRespHeader( "Access-Control-Allow-Headers", "Access-Control-Allow-Headers, Origin,Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers" );

pa_id = OptInt(Request.QueryString.GetOptProperty("pa_id"));
pa = ArrayOptFirstElem(XQuery("for $elem in pas where $elem/id = "+pa_id+" return $elem"));

pa_doc = tools.open_doc(pa_id);
pa_doc = pa_doc != undefined ? pa_doc.TopElem : null; 

plan = ArrayOptFirstElem(XQuery("for $elem in assessment_plans where $elem/id = "+pa.assessment_plan_id+" return $elem"));
plan_doc = tools.open_doc(pa.assessment_plan_id);
plan_doc = plan_doc != undefined ? plan_doc.TopElem : null; 
plan_comments = [];
arr_score = [];

for(elem in plan_doc.custom_comments){
    persDoc = tools.open_doc(elem.person_id).TopElem;
    workflowDoc = tools.open_doc(plan_doc.workflow_id ).TopElem;
    objWfStateName = ArrayOptFirstElem(ArraySelect(workflowDoc.states.state, "code == '"+elem.workflow_state+"'"));
    wfStateName = objWfStateName != undefined ? String(objWfStateName.name) : "Этап не определен";
    plan_comments.push({
        person_id: String(elem.person_id),
        person_fio: persDoc.lastname + " "+persDoc.firstname + " " + persDoc.middlename,
        person_position: String(persDoc.position_name),
        comment_date: StrDate(elem.comment_date, true),
        comment: String(elem.comment),
        workflow_state: wfStateName
    });
}
//заполняем поля для виджетов итоговой оценки 
for (customElem in plan_doc.custom_elems.custom_elem) {
    if(customElem.name=="post_develop_group" ) { 
        descript = "--";     
        itog_score = String(customElem.value);
        switch (itog_score){
            case 'III BR':
            case 'III B': 
                descript = 'Профессионал';
                break;
            case 'III AR':
            case  'III A':
                descript = 'Резерв';
                break;
            case 'II B':
            case 'II A':
                descript = 'Новички';
                break;
            case 'I B':
                descript = 'Будущий проф.';
                break;
            case 'I A':
                descript = 'Потенциал';
                break;
            case 'I':
                descript = 'Группа контроля';
                break;
            default:
                descript = 'Новички';
                break;
        }
        arr_score.push({title: 'Группа развития',
                        val: itog_score,
                        desc: descript,
                        order: 1});
    }
    if(customElem.name=="IQ" ) {
        arr_score.push({title: 'Оценка IQ',
        val: String(customElem.value),
        order: 5
       });
    }
    if(customElem.name=="hogan" ) {
        arr_score.push({title: 'Hogan',
        val: String(customElem.value),
        order: 6
       });
    }		
    if(customElem.name=="assess_position") {// оценка соотв должности
        assesPosit = String(customElem.value);
        descript = "--";
        if (OptReal(assesPosit,0) <= 1.7)
            descript = 'Зона роста';
        else{
            if (OptReal(assesPosit,0) <= 2.7 && OptReal(assesPosit,0) > 1.7)
                descript = 'Частичное';
                else{
                    if (OptReal(assesPosit,0) > 2.7) 
                        descript = 'Полное';
                }
        }
        arr_score.push({title: 'Соответствие',
                        val: assesPosit,
                        desc: descript,
                        order: 2
                        });
    }
    if(customElem.name=="assess_result" ) {//оценка результативности
        assesResult = String(customElem.value);
        descript = "--";
        if (OptReal(assesResult,0) == 1)
            descript = 'Не результативен';
            else{
                if (OptReal(assesResult,0) == 2)
                    descript = 'Результативен';
                    else {
                        if (OptReal(assesResult,0) == 3)
                            descript = 'Выше ожиданий';
                    }
            }
        arr_score.push({title: 'Результативность',
                        val: assesResult,
                        desc: descript,
                        order: 3
                        });
    }	
    if(customElem.name=="assess_potential" ) {//оценка потенциала
        assesPoten = String(customElem.value);
        descript = "--";
        if (OptReal(assesPoten,0) <= 1.7)
            descript = 'Реализован';
        else{
            if (OptReal(assesPoten,0) <= 2.7 && OptReal(assesPoten,0) > 1.7)
                descript = 'В должности';
                else{
                    if (OptReal(assesPoten,0) > 2.7) 
                        descript = 'Потенциал';
                }
        }                                      
        arr_score.push({title: 'Потенциал',
                        val: assesPoten,
                        desc: descript,
                        order: 4
                        });
    }			
}

boss = ArrayOptFirstElem(XQuery("for $elem in collaborators where $elem/id = "+plan.boss_id+" return $elem"));

result = {
    pa: pa,
    pa_doc: pa_doc,
    plan: plan,
    plan_comments: plan_comments,
    arr_score: ArraySort(arr_score, 'This.order', '+'),
    boss: {
        boss_id: String(boss.id),
        fullname: String(boss.fullname),
	    position: String(boss.position_name),
        pict_url: String(boss.pict_url)
    }
};

expert_id = ArrayOptFirstElem(plan.custom_experts_array);
if(expert_id != undefined) {
    expert = ArrayOptFirstElem(XQuery("for $elem in collaborators where $elem/id = "+expert_id+" return $elem"));
    result.expert = {
        expert_id: String(expert_id),
        fullname: String(expert.fullname),
	    position: String(expert.position_name),
        pict_url: String(expert.pict_url)
    }
}
else {
    result.expert = null;
}

if(plan.expert_person_id != null) {
    hr = ArrayOptFirstElem(XQuery("for $elem in collaborators where $elem/id = "+plan.expert_person_id+" return $elem"));
    result.hr = {
        hr_id: String(plan.expert_person_id),
        fullname: String(hr.fullname),
	    position: String(hr.position_name),
        pict_url: String(hr.pict_url)
    }
}
else {
    result.hr = null;
}


competence_scales = [];
indicator_scales = [];
question_scales = [];
for(pa_comp in pa_doc.competences) {
    competence_doc = tools.open_doc(pa_comp.competence_id);
    if(competence_doc != undefined) {
        competence_doc = competence_doc.TopElem;
            
        if(pa_comp.plan != null && pa_comp.plan != '' || pa_comp.plan_text != null && pa_comp.plan_text != '' || pa_comp.plan_value != null && pa_comp.plan_value != '') {
            competence_scales.push({
                id: String(competence_doc.id),
                name: String(competence_doc.name),
                desc: String(competence_doc.desc),
                scales: competence_doc.scales
            });
        }
        for(pa_indic in pa_comp.indicators) {
            indicator_doc = tools.open_doc(pa_indic.indicator_id);
            if(indicator_doc != undefined) {
                indicator_doc = indicator_doc.TopElem;
                indicator_scales.push({
                    competence_id: String(competence_doc.id),
                    competence_name: String(competence_doc.name),
                    id: String(indicator_doc.id),
                    name: String(indicator_doc.name),
                    scales: indicator_doc.scales
                });
            }
        }
    }
}

for(pa_question in pa_doc.supplementary_questions) {
    question_doc = tools.open_doc(pa_question.supplementary_question_id);
    if(question_doc != undefined) {
        question_doc = question_doc.TopElem;
        question_scales.push({
            id: String(pa_question.supplementary_question_id),
            name: String(question_doc.name),
            scales: question_doc.scales
        });
    }
}

//alert(tools.object_to_text(competence_scales,'json'));
result.competence_scales = competence_scales;
result.indicator_scales = indicator_scales;
result.question_scales = question_scales;

pa_type_instruction = undefined;
switch (pa.assessment_appraise_type) {
    case 'competence_appraisal':
        pa_type_instruction = tools.open_doc(7324579894839891006);
        break;
    case 'position_appraisal':
        pa_type_instruction = tools.open_doc(7324579894839891006); //TODO fix id
        break;
    case 'staffrating':
        pa_type_instruction = tools.open_doc(7324579894839891006); //TODO fix id
        break;
    case 'development_plan':
        pa_type_instruction = tools.open_doc(7324579894839891006); //TODO fix id
    default:
        break;
}
result.instruction = (pa_type_instruction != undefined) ? String(pa_type_instruction.TopElem.text_area) : null;

Response.Write(tools.object_to_text(result, 'json'));
%>